{% extends 'base.html' %}
{% load tz %}
{% load scheduler_extras %} 

{% block title %}Edit Schedule: {{ season.name }}{% endblock %}

{% block extra_css %}
<style>
    .score-input {
        width: 60px;
        display: inline-block;
        margin: 0 5px;
    }
    .vs-separator {
        display: inline-block;
        width: 20px;
        text-align: center;
    }
    .form-control-sm {
        padding: 0.25rem 0.5rem;
        font-size: .875rem;
        min-width: 100px; /* Prevent dropdowns from becoming too small */
    }
    th, td {
        vertical-align: middle;
    }
    .datetime-input {
        min-width: 180px; /* Adjust as needed */
    }
    .row-changed {
        background-color: #fff3cd !important; /* Light yellow background for changed rows */
    }

    /* --- NEW Collapsible Week Styles --- */
    .week-container {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 1.5rem; /* Add space between weeks */
        overflow: hidden; /* Ensure content hides properly */
    }

    .week-header {
        background-color: #f8f9fa; /* Light background for header */
        padding: 0.75rem 1.25rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
    }

    .week-header h3 {
        margin-bottom: 0; /* Remove default margin */
        font-size: 1.25rem; /* Adjust size as needed */
    }

    .week-header:hover {
        background-color: #e9ecef; /* Slightly darker on hover */
    }

    .week-header::before {
        content: '▼'; /* Down arrow for expanded */
        font-size: 1rem;
        margin-right: 0.75rem;
        color: #6c757d; /* Muted color */
    }

    .week-container.collapsed .week-header::before {
        content: '►'; /* Right arrow for collapsed */
    }

    .week-content {
        padding: 1rem; /* Add padding around the table */
        /* Transition can be added for smoother collapse/expand */
        /* transition: all 0.3s ease-in-out; */
    }

    .week-container.collapsed .week-content {
        display: none;
    }
    /* --- END NEW Collapsible Week Styles --- */

    /* Style to visually indicate disabled state beyond default */
    .schedule-input:disabled,
    .delete-game-btn:disabled,
    .add-game-btn:disabled {
        cursor: not-allowed;
        /* Optional: Adjust opacity or background if needed */
        /* background-color: #e9ecef; */
        /* opacity: 0.7; */
    }
    .form-switch .form-check-label {
        cursor: pointer; /* Make label clickable */
        padding-left: 0.5em; /* Add space between switch and label */
    }
</style>
{% endblock %}


{% block content %}
<div class="container-fluid mt-4"> {% comment %} Use container-fluid for wider tables {% endcomment %}
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"> {# Added flex-wrap and gap #}
        <h2>Edit Schedule/Scores: {{ season.name }}</h2> {# Updated Title #}
        {# --- ADDED: Toggle Switch --- #}
        <div class="form-check form-switch align-self-center"> {# Align switch vertically #}
            <input class="form-check-input" type="checkbox" role="switch" id="enableScheduleEditToggle">
            <label class="form-check-label" for="enableScheduleEditToggle">Enable Schedule Editing</label>
        </div>
        {# --- END ADDED --- #}
        <div class="d-flex gap-2"> {# Group for top buttons #}
            {# Updated link to go back to the main seasons list page #}
            <a href="{% url 'scheduler:season_list' %}" class="btn btn-secondary">Back to Seasons List</a>
            <button type="submit" form="scheduleEditForm" class="btn btn-success">Save All Changes</button> {# Moved Save Button (uses form attribute) #}
        </div>
    </div>


    {% if not games_by_week %}
        <p class="alert alert-info">No games found for this season.</p>
    {% else %}
        <form id="scheduleEditForm" method="post" action="" autocomplete="off"> {% comment %} ADDED autocomplete="off" HERE {% endcomment %}
            {% csrf_token %}

            {% for week, games_in_week in games_by_week.items %}
                {# --- NEW: Week Container --- #}
                <div class="week-container" data-week-id="{{ week }}">
                    <div class="week-header"> {# --- NEW: Clickable Header --- #}
                        <h3>Week {{ week }}</h3>
                        {# Arrow will be added via CSS ::before #}
                    </div>
                    <div class="week-content"> {# --- NEW: Content Wrapper --- #}
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Court</th>
                                        <th>Level</th>
                                        <th>Team 1</th>
                                        <th>Score</th>
                                        <th>Team 2</th>
                                        <th>Referee</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody class="schedule-table-body">
                                    {% for game in games_in_week %}
                                        <tr data-game-id="{{ game.id }}">
                                            {# Date/Time - Always editable #}
                                            <td>
                                                <input type="datetime-local" name="datetime_{{ game.id }}"
                                                       value="{{ game.date_time|date:'Y-m-d\TH:i' }}"
                                                       class="form-control form-control-sm datetime-input schedule-input"
                                                       data-original-value="{{ game.date_time|date:'Y-m-d\TH:i'|default:'' }}">
                                            </td>
                                            {# Court - Always editable #}
                                            <td>
                                                <select name="court_{{ game.id }}" class="form-select form-select-sm schedule-input"
                                                        data-original-value="{{ game.court|default:'' }}">
                                                    <option value="">---------</option>
                                                    {% for court_name in courts %}
                                                        <option value="{{ court_name }}" {% if game.court == court_name %}selected{% endif %}>
                                                            {{ court_name }}
                                                        </option>
                                                    {% endfor %}
                                                    {% if game.court and game.court not in courts %}
                                                    <option value="{{ game.court }}" selected>(!) {{ game.court }}</option>
                                                    {% endif %}
                                                </select>
                                            </td>
                                            {# Level - Always editable #}
                                            <td>
                                                <select name="level_{{ game.id }}" class="form-select form-select-sm level-select schedule-input"
                                                        data-original-value="{{ game.level.id }}">
                                                    <option value="">---------</option>
                                                    {% for level_obj in levels %}
                                                        <option value="{{ level_obj.id }}" {% if game.level.id == level_obj.id %}selected{% endif %}>
                                                            {{ level_obj.name }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            {# Team 1 - Use teams_by_level_objects #}
                                            <td>
                                                <select name="team1_{{ game.id }}" class="form-select form-select-sm team-select team1-select schedule-input"
                                                        data-original-value="{{ game.team1_id }}">
                                                    <option value="">---------</option>
                                                    {% for team in teams_by_level_objects|lookup:game.level.id %}
                                                         <option value="{{ team.id }}" {% if game.team1_id == team.id %}selected{% endif %}>
                                                            {{ team.name }}
                                                        </option>
                                                    {% empty %}
                                                        <option value="" disabled>No teams in level</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            {# Score - Always editable #}
                                            <td class="text-center">
                                                <input type="number" name="score1_{{ game.id }}" value="{{ game.team1_score }}"
                                                       class="form-control form-control-sm score-input schedule-input" min="0" placeholder="S1"
                                                       data-original-value="{{ game.team1_score|default:'' }}">
                                                <span class="vs-separator">-</span>
                                                <input type="number" name="score2_{{ game.id }}" value="{{ game.team2_score }}"
                                                       class="form-control form-control-sm score-input schedule-input" min="0" placeholder="S2"
                                                       data-original-value="{{ game.team2_score|default:'' }}">
                                            </td>
                                             {# Team 2 - Use teams_by_level_objects #}
                                            <td>
                                                <select name="team2_{{ game.id }}" class="form-select form-select-sm team-select team2-select schedule-input"
                                                        data-original-value="{{ game.team2_id }}">
                                                    <option value="">---------</option>
                                                    {% for team in teams_by_level_objects|lookup:game.level.id %}
                                                         <option value="{{ team.id }}" {% if game.team2_id == team.id %}selected{% endif %}>
                                                            {{ team.name }}
                                                        </option>
                                                    {% empty %}
                                                         <option value="" disabled>No teams in level</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            {# Referee - Use teams_by_level_objects #}
                                            <td>
                                                <select name="referee_{{ game.id }}" class="form-select form-select-sm team-select ref-select schedule-input"
                                                        data-original-value="{{ game.referee_team_id|default:'' }}">
                                                    <option value="">---------</option>
                                                     {% for team in teams_by_level_objects|lookup:game.level.id %}
                                                         <option value="{{ team.id }}" {% if game.referee_team_id == team.id %}selected{% endif %}>
                                                            {{ team.name }}
                                                        </option>
                                                    {% empty %}
                                                         <option value="" disabled>No teams in level</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            {# --- ADDED: Delete Button Cell --- #}
                                            <td class="text-center">
                                                <button type="button" class="btn btn-sm btn-danger delete-game-btn" title="Delete Game">
                                                    <i class="fas fa-times"></i> {# Or use text 'X' #}
                                                </button>
                                            </td>
                                            {# --- END ADDED --- #}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Moved Add Game button here and left-aligned it -->
                        <div class="text-start mt-3">
                            <button type="button" class="btn btn-sm btn-primary add-game-btn" data-week-id="{{ week }}">
                                <i class="fas fa-plus"></i> Add Game to Week {{ week }}
                            </button>
                        </div>
                    </div> {# --- END: Content Wrapper --- #}
                    
                    <!-- Remove the button from here -->
                </div> {# --- END: Week Container --- #}
            {% endfor %}

            {# Save button is always present in edit view #}
            {# <div class="form-actions mt-4 mb-4 text-end"> #}
                {# <button type="submit" class="btn btn-success">Save All Changes</button> #}
                {# {% comment %} TODO: Add "Add Game" button? {% endcomment %} #}
            {# </div> #} {# Removed original Save button container #}
        </form>
    {% endif %}

</div>

{# Pass JSON-serializable teams data to JavaScript - Use the new variable #}
{{ teams_data_for_js|json_script:"teams-by-level-data" }}
{# Add json_script for levels data #}
{{ levels_data_for_js|json_script:"levels-data" }}
{{ courts|json_script:"courts-data" }}

{% endblock %}

{% block extra_js %}
<script>
// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
// Get season ID from URL
const seasonId = window.location.pathname.split('/')[3];

// --- NEW: Function to handle week collapsing ---
function setupCollapsibleWeeks() {
    document.querySelectorAll('.week-header').forEach(header => {
        header.addEventListener('click', function() {
            const weekContainer = this.closest('.week-container');
            if (weekContainer) {
                weekContainer.classList.toggle('collapsed');
            }
        });
    });
}

// --- NEW: Function to check scores and pre-collapse weeks ---
function preCollapseCompletedWeeks() {
    document.querySelectorAll('.week-container').forEach(weekContainer => {
        let allScoresEntered = true;
        const gameRows = weekContainer.querySelectorAll('.schedule-table-body tr[data-game-id]');

        if (gameRows.length === 0) {
            allScoresEntered = false; // Don't collapse weeks with no games
        }

        gameRows.forEach(row => {
            const score1Input = row.querySelector('input[name^="score1_"]');
            const score2Input = row.querySelector('input[name^="score2_"]');

            // Check if either score input exists and is empty
            if (!score1Input || score1Input.value.trim() === '' || !score2Input || score2Input.value.trim() === '') {
                allScoresEntered = false;
            }
        });

        if (allScoresEntered) {
            weekContainer.classList.add('collapsed');
        } else {
             weekContainer.classList.remove('collapsed'); // Ensure it's expanded if not complete
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // console.log("Schedule edit page loaded."); // Keep or remove as desired

    const teamsByLevelDataElement = document.getElementById('teams-by-level-data');
    if (!teamsByLevelDataElement) {
        console.error("Fatal: Script tag with ID 'teams-by-level-data' not found!");
        return;
    }

    let teamsByLevelData;
    try {
        // Parse the JSON - Removed debugging logs around here
        teamsByLevelData = JSON.parse(teamsByLevelDataElement.textContent);
    } catch (e) {
        console.error("Fatal: Failed to parse teamsByLevelData JSON!", e);
        alert("Error loading team data. Editing may not work correctly.");
        teamsByLevelData = {}; // Assign empty object on error
    }

    // --- REMOVED originalGameData declaration here ---
    // let originalGameData = {};

    // Function to fetch original data (Still needed AFTER save)
    function fetchOriginalGameData() {
        fetch(`/scheduler/schedule/${seasonId}/data/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
             })
            .then(data => {
                // Build the originalGameData map *locally* just for this update
                const freshOriginalGameData = (data.games || []).reduce((acc, game) => {
                    acc[game.id] = game;
                    return acc;
                }, {});
                // console.log("fetchOriginalGameData updated original values from:", JSON.parse(JSON.stringify(freshOriginalGameData))); // Optional debug log

                // Update ONLY the data-original-value attributes
                document.querySelectorAll('tbody tr[data-game-id]').forEach(row => {
                    const gameId = row.dataset.gameId;
                    // Ensure gameId is treated consistently (string comparison often safer)
                    const original = freshOriginalGameData[String(gameId)]; // Access using string key if IDs might mix types
                    if (original) {
                        row.querySelectorAll('.schedule-input').forEach(input => {
                            const name = input.name.split('_')[0];
                            let originalValue = '';
                            // --- Use the fetched 'original' object ---
                            switch (name) {
                                case 'datetime': originalValue = original.datetime || ''; break; // Assuming 'datetime' is the key in JSON
                                case 'court': originalValue = original.court || ''; break;
                                case 'level': originalValue = original.level || ''; break;     // Assuming 'level' is the level ID in JSON
                                case 'team1': originalValue = original.team1 || ''; break;     // Assuming 'team1' is the team ID in JSON
                                case 'score1': originalValue = original.score1 || ''; break;
                                case 'team2': originalValue = original.team2 || ''; break;     // Assuming 'team2' is the team ID in JSON
                                case 'score2': originalValue = original.score2 || ''; break;
                                case 'referee': originalValue = original.referee || ''; break; // Assuming 'referee' is the team ID in JSON
                            }
                            // --- Important: Convert null/undefined to empty string for attribute ---
                            input.dataset.originalValue = String(originalValue !== null && originalValue !== undefined ? originalValue : '');
                        });
                    } else {
                         // If a game was just added, it won't have fetched original data yet.
                         // We should set its original value to its current value or leave it empty.
                         // For simplicity, if it's not found in fetched data, we can assume
                         // its server-rendered state (or current state if just added) is the baseline.
                         // Let's ensure existing ones are updated, and skip ones not found in the fetch.
                         if (row.dataset.isNew !== "true") {
                            console.warn(`Original data not found for existing game ID ${gameId} after save/fetch.`);
                         }
                    }
                });
                // --- END MODIFICATION ---

                // Reset highlights after updating original values
                resetHighlights();

                 // Pre-collapse weeks based on current state
                 preCollapseCompletedWeeks();

            })
            .catch(error => {
                console.error("Error fetching original game data post-save:", error);
                alert("Could not refresh game data after saving. Highlighting might be incorrect until page reload.");
            });
    }

    // --- ADD isGameRowValid function definition here ---
    function isGameRowValid(rowElement) {
        if (!rowElement) return false; // Guard against null rows
        const levelSelect = rowElement.querySelector('.level-select');
        const team1Select = rowElement.querySelector('.team1-select');
        const team2Select = rowElement.querySelector('.team2-select');

        // Check if required fields are selected
        const isValid = levelSelect && levelSelect.value &&
                        team1Select && team1Select.value &&
                        team2Select && team2Select.value;

        // Add/remove visual indication
        if (!isValid) {
            rowElement.classList.add('table-danger'); // Use Bootstrap's danger color
            console.warn(`Game row (ID: ${rowElement.dataset.gameId || 'NEW'}) is invalid: Missing Level, Team1, or Team2.`);
        } else {
            rowElement.classList.remove('table-danger');
        }
        return isValid;
    }
    // --- END ADDED function definition ---

    // --- REMOVED the initial call to fetchOriginalGameData ---
    // Fetch original data when the page loads
    // fetchOriginalGameData();

    // --- Run pre-collapse check on initial load based on rendered values ---
    preCollapseCompletedWeeks();

    // Function to check if a row has changed and apply highlighting
    function checkAndHighlightRow(rowElement) {
        if (!rowElement) return;
        let hasChanged = false;
        const inputs = rowElement.querySelectorAll('.schedule-input'); // Select elements by common class

        inputs.forEach(input => {
            const currentValue = (input.type === 'number' && input.value === '') ? '' : input.value; // Treat empty number as empty string for comparison
            const originalValue = input.dataset.originalValue || ''; // Default original to empty string if not set

            // Handle potential type differences for comparison (e.g., number vs string)
            if (String(currentValue) !== String(originalValue)) {
                 hasChanged = true;
            }
        });

        if (hasChanged) {
            rowElement.classList.add('row-changed');
        } else {
            rowElement.classList.remove('row-changed');
        }
        return hasChanged; // Return whether the row changed
    }

    // Add event listener using delegation on table bodies
    document.querySelectorAll('.schedule-table-body').forEach(tbody => {
        tbody.addEventListener('change', function(event) {
            if (event.target.classList.contains('schedule-input')) {
                const row = event.target.closest('tr');
                checkAndHighlightRow(row);
                 // Also remove validation error highlight on change
                 if (row.classList.contains('table-danger')) {
                      isGameRowValid(row); // Re-validate to potentially clear error style
                 }
            }
        });
         // Also listen for 'input' on text/number fields for faster feedback
         tbody.addEventListener('input', function(event) {
            if (event.target.matches('input.schedule-input[type="number"], input.schedule-input[type="datetime-local"]')) {
                 const row = event.target.closest('tr');
                 checkAndHighlightRow(row);
                  // Also remove validation error highlight on input
                  if (row.classList.contains('table-danger')) {
                      isGameRowValid(row); // Re-validate
                  }
            }
         });

        // --- Listener for Delete Buttons ---
        tbody.addEventListener('click', function(event) {
            // Find the closest button with the delete class
            const deleteButton = event.target.closest('.delete-game-btn');

            if (deleteButton) {
                event.preventDefault(); // Prevent any default button action
                const rowToDelete = deleteButton.closest('tr');
                const gameId = rowToDelete.dataset.gameId; // Get game ID (could be real or temporary)
                const isNew = rowToDelete.dataset.isNew === "true";

                // Confirmation dialog
                const confirmMessage = isNew
                    ? "Are you sure you want to remove this newly added game?"
                    : `Are you sure you want to remove this game? It will be deleted when you save changes.`; // Simplified confirmation

                if (confirm(confirmMessage)) {
                    console.log(`Removing row for game ID: ${gameId} (isNew: ${isNew})`);
                    rowToDelete.remove(); // Remove the row from the table

                    // NOTE: Since the backend deletes all games for the season and recreates
                    // them based on the submitted data, removing the row here is sufficient
                    // to prevent this game from being saved/recreated.
                }
            }
        });
        // --- END Delete Button Listener ---
    });

    // Function to update team dropdowns
    function updateTeamDropdowns(gameRow, levelId) {
        const levelIdStr = String(levelId);
        // console.log(`Updating dropdowns for levelIdStr: "${levelIdStr}"`); // Removed log

        if (!teamsByLevelData || typeof teamsByLevelData !== 'object' || teamsByLevelData === null) {
             console.error("teamsByLevelData is not available or not an object!");
             return;
        }

        const teamsForLevel = teamsByLevelData[levelIdStr];

        // Removed detailed debugging logs for teamsForLevel
        // console.log(`Value found for teamsByLevelData["${levelIdStr}"]:`, teamsForLevel);
        // console.log(`Is teamsForLevel an array? ${Array.isArray(teamsForLevel)}`);

        const teams = Array.isArray(teamsForLevel) ? teamsForLevel : [];

        // Removed check for 'teams' variable type as Array.isArray handles it
        // if (!Array.isArray(teams)) { ... }

        const teamSelects = gameRow.querySelectorAll('.team-select');

        teamSelects.forEach(select => {
            const currentSelectedValue = select.value;
            select.innerHTML = '<option value="">---------</option>';

            try {
                 teams.forEach(team => {
                     const option = document.createElement('option');
                     option.value = team.id;
                     option.textContent = team.name;
                     if (String(team.id) === String(currentSelectedValue)) {
                         option.selected = true;
                     }
                     select.appendChild(option);
                 });
            } catch(e) {
                 console.error("Error during teams.forEach loop:", e); // Keep error log
                 // console.error("The 'teams' variable causing the error:", teams); // Removed detailed log
            }

            if (teams.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No teams available";
                option.disabled = true;
                select.appendChild(option);
            }
        });
        // ---- Trigger highlight check after dropdown update ----
        checkAndHighlightRow(gameRow);
        // ------------------------------------------------------
    }

    // Add event listeners to all level dropdowns
    document.querySelectorAll('.level-select').forEach(select => {
        select.addEventListener('change', function(event) {
            const gameRow = event.target.closest('tr');
            const gameId = gameRow.dataset.gameId;
            const selectedLevelId = event.target.value;
            // console.log(`Level changed for game ${gameId} to ${selectedLevelId}`); // Keep or remove as desired
            updateTeamDropdowns(gameRow, selectedLevelId);
        });
    });

    // Handle form submission
    const form = document.getElementById('scheduleEditForm');
    const submitButton = document.querySelector('button[type="submit"][form="scheduleEditForm"]');

    if (!submitButton) {
        console.error("Fatal: Save button with form='scheduleEditForm' not found!");
        // Optionally disable the form or show an error message
        return;
    }

    // --- NEW: Add Game Button functionality ---
    let tempGameIdCounter = -1; // Counter for temporary IDs (negative to avoid conflicts with real IDs)
    
    // Parse the data from JSON script tags
    const levelsData = JSON.parse(document.getElementById('levels-data').textContent);
    const courtsData = JSON.parse(document.getElementById('courts-data').textContent);
    
    // Add event listeners to all Add Game buttons
    document.querySelectorAll('.add-game-btn').forEach(button => {
        button.addEventListener('click', function() {
            const weekId = this.dataset.weekId;
            const weekContainer = this.closest('.week-container');
            const tableBody = weekContainer.querySelector('.schedule-table-body');
            
            if (!tableBody) {
                console.error("Could not find table body in week container");
                return;
            }
            
            // Generate a temporary negative ID for the new game
            const tempGameId = tempGameIdCounter--;
            
            // Create a new row
            const newRow = document.createElement('tr');
            newRow.dataset.gameId = tempGameId;
            newRow.dataset.isNew = "true"; // Mark as a new game for the backend
            
            // Get the level associated with this week's table (for default level dropdown)
            const firstLevelInWeek = tableBody.querySelector('.level-select')?.value || '';
            
            // Build court options directly from courtsData
            let courtOptions = '<option value="">---------</option>';
            courtsData.forEach(court => {
                courtOptions += `<option value="${court}">${court}</option>`;
            });
            
            // Build level options directly from levelsData
            let levelOptions = '<option value="">---------</option>';
            levelsData.forEach(level => {
                levelOptions += `<option value="${level.id}" ${level.id === firstLevelInWeek ? 'selected' : ''}>${level.name}</option>`;
            });
            
            // Build the HTML for the new row using these options
            newRow.innerHTML = `
                <td>
                    <input type="datetime-local" name="datetime_${tempGameId}"
                           value=""
                           class="form-control form-control-sm datetime-input schedule-input"
                           data-original-value="">
                </td>
                <td>
                    <select name="court_${tempGameId}" class="form-select form-select-sm schedule-input"
                            data-original-value="">
                        ${courtOptions}
                    </select>
                </td>
                <td>
                    <select name="level_${tempGameId}" class="form-select form-select-sm level-select schedule-input"
                            data-original-value="">
                        ${levelOptions}
                    </select>
                </td>
                <td>
                    <select name="team1_${tempGameId}" class="form-select form-select-sm team-select team1-select schedule-input"
                            data-original-value="">
                        <option value="">---------</option>
                    </select>
                </td>
                <td class="text-center">
                    <input type="number" name="score1_${tempGameId}" value=""
                           class="form-control form-control-sm score-input schedule-input" min="0" placeholder="S1"
                           data-original-value="">
                    <span class="vs-separator">-</span>
                    <input type="number" name="score2_${tempGameId}" value=""
                           class="form-control form-control-sm score-input schedule-input" min="0" placeholder="S2"
                           data-original-value="">
                </td>
                <td>
                    <select name="team2_${tempGameId}" class="form-select form-select-sm team-select team2-select schedule-input"
                            data-original-value="">
                        <option value="">---------</option>
                    </select>
                </td>
                <td>
                    <select name="referee_${tempGameId}" class="form-select form-select-sm team-select ref-select schedule-input"
                            data-original-value="">
                        <option value="">---------</option>
                    </select>
                </td>
                {# --- ADDED: Delete Button Cell for New Rows --- #}
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-danger delete-game-btn" title="Delete Game">
                        <i class="fas fa-times"></i> {# Or use text 'X' #}
                    </button>
                </td>
                {# --- END ADDED --- #}
            `;
            
            // Add the new row to the table
            tableBody.appendChild(newRow);
            
            // Set the week appropriately
            const levelSelect = newRow.querySelector('.level-select');
            if (levelSelect && levelSelect.value) {
                // Trigger the change event to populate team dropdowns
                const event = new Event('change', { bubbles: true });
                levelSelect.dispatchEvent(event);
            }
            
            // Mark the row as changed
            newRow.classList.add('row-changed');
            
            // Expand the week if it was collapsed
            if (weekContainer.classList.contains('collapsed')) {
                weekContainer.classList.remove('collapsed');
            }
            
            // ... Add logging to help debug team dropdowns
            if (levelSelect) {
                console.log("Adding change event listener to new level select");
                levelSelect.addEventListener('change', function() {
                    console.log("Level changed to:", this.value);
                    updateTeamDropdowns(newRow, this.value);
                });
            }
        });
    });
    // --- END NEW: Add Game Button functionality ---

    // Update form submission to include new games and confirmation
    form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const allGameRows = form.querySelectorAll('.schedule-table-body tr[data-game-id]');
        const allGamesData = [];
        let isValid = true;
        let modifiedRowCount = 0;
        let newRowCount = 0;

        allGameRows.forEach(row => {
            if (!isGameRowValid(row)) {
                isValid = false;
                console.error("Invalid game row found:", row);
            }

            // --- Count changes for confirmation ---
            if (row.classList.contains('row-changed')) {
                 // Only count as modified if it's NOT new (new rows always start as 'changed')
                if (row.dataset.isNew !== "true") {
                    modifiedRowCount++;
                }
            }
            if (row.dataset.isNew === "true") {
                newRowCount++;
            }
            // --- End counting ---

            const gameId = row.dataset.gameId;
            const isNew = row.dataset.isNew === "true";
            const gameData = {
                id: gameId,
                is_new: isNew,
                week: row.closest('.week-container')?.dataset?.weekId || null,
                datetime: row.querySelector(`[name="datetime_${gameId}"]`).value || null,
                court: row.querySelector(`[name="court_${gameId}"]`).value || null,
                level: row.querySelector(`[name="level_${gameId}"]`).value,
                team1: row.querySelector(`[name="team1_${gameId}"]`).value,
                team2: row.querySelector(`[name="team2_${gameId}"]`).value,
                referee: row.querySelector(`[name="referee_${gameId}"]`).value || null,
                score1: row.querySelector(`[name="score1_${gameId}"]`).value || null,
                score2: row.querySelector(`[name="score2_${gameId}"]`).value || null,
            };
            allGamesData.push(gameData);
        });

        if (!isValid) {
             alert("Please fix the errors in the highlighted rows before saving.");
             if (submitButton) submitButton.disabled = false; // Re-enable button on validation failure
             return;
        }

        // --- ADD CONFIRMATION DIALOG ---
        const totalChanges = modifiedRowCount + newRowCount;
        if (totalChanges === 0) {
            alert("No changes detected to save.");
             if (submitButton) submitButton.disabled = false; // Re-enable button
            return; // Don't proceed if nothing changed
        }

        let confirmationMessage = `You are about to save changes:\n`;
        if (newRowCount > 0) {
            confirmationMessage += `- ${newRowCount} new game(s) will be added.\n`;
        }
        if (modifiedRowCount > 0) {
            confirmationMessage += `- ${modifiedRowCount} existing game(s) will be updated.\n`;
        }
        confirmationMessage += `\nProceed?`;

        if (!confirm(confirmationMessage)) {
            console.log("Save cancelled by user.");
            if (submitButton) submitButton.disabled = false; // Re-enable button on cancel
            return; // Stop submission if user cancels
        }
        // --- END CONFIRMATION DIALOG ---


        // Disable submit button to prevent multiple submissions *after* confirmation
        if (submitButton) submitButton.disabled = true;

        console.log("Submitting data:", allGamesData);

        // --- Send data to the backend ---
        try {
            const response = await fetch(`/scheduler/schedule/${seasonId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ games: allGamesData })
            });

            if (!response.ok) {
                // Attempt to parse JSON error detail
                let errorMessage = 'Failed to save schedule'; // Default error message
                try {
                    const errorData = await response.json();
                    // --- MODIFICATION START: Access 'details' array ---
                    if (errorData.details && Array.isArray(errorData.details) && errorData.details.length > 0) {
                        // Join array elements for a more complete message, or just take the first one
                        errorMessage = errorData.details.join('; '); // Join multiple errors with '; '
                        // Alternatively, just show the first error: errorMessage = errorData.details[0];
                    } else if (errorData.error) {
                         // Fallback to the top-level 'error' key if 'details' is not informative
                         errorMessage = errorData.error;
                    }
                    // --- MODIFICATION END ---
                } catch (parseError) {
                    // If JSON parsing fails entirely, use a generic message
                    errorMessage = 'Could not parse error response from server.';
                    console.error("Failed to parse error JSON:", parseError);
                }
                 // Construct a meaningful error message including the status and the extracted message
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorMessage}`);
            }

            const result = await response.json();
            console.log('Save successful:', result);
            alert('Schedule updated successfully!');

            // --- IMPORTANT: Update original data after successful save ---
            fetchOriginalGameData();


        } catch (error) { // This catch block handles errors thrown above or network errors
            console.error('Error saving schedule:', error);
             // The alert uses error.message, which should now contain the detail we extracted correctly
            alert(`Failed to save schedule: ${error.message}`);
        } finally {
            // Re-enable submit button regardless of success or failure
            // (Button is already re-enabled earlier if validation fails or user cancels)
             if (submitButton) submitButton.disabled = false;
        }
    });

    // Function to reset all highlights
    function resetHighlights() {
         document.querySelectorAll('.schedule-table-body tr.row-changed').forEach(row => {
            row.classList.remove('row-changed');
        });
        // Also remove validation error highlights
        document.querySelectorAll('.schedule-table-body tr.table-danger').forEach(row => {
            row.classList.remove('table-danger');
        });
    }

    // --- NEW: Setup collapsible functionality ---
    setupCollapsibleWeeks();

    // --- REMOVED the second call to fetchOriginalGameData ---
    // Fetch original data when the page loads
    // fetchOriginalGameData(); // This now also triggers the initial pre-collapse check via its .then()

    const scheduleForm = document.getElementById('scheduleEditForm');
    const scheduleEditToggle = document.getElementById('enableScheduleEditToggle');

    // --- NEW: Function to toggle editing state ---
    function toggleScheduleEditing(isEnabled) {
        console.log(`Toggling schedule editing: ${isEnabled}`); // For debugging

        // Select all relevant inputs/buttons *within the form*
        // Exclude score inputs from the general disabling selector
        scheduleForm.querySelectorAll('.schedule-input:not([name^="score1_"]):not([name^="score2_"]), .delete-game-btn, .add-game-btn')
            .forEach(element => {
                element.disabled = !isEnabled;
            });

        // Ensure score inputs are *always* enabled (in case they were somehow disabled)
        scheduleForm.querySelectorAll('input[name^="score1_"], input[name^="score2_"]')
            .forEach(scoreInput => {
                scoreInput.disabled = false;
            });

        // Optional: Add/remove a class to the form for global styling changes
        if (isEnabled) {
            scheduleForm.classList.remove('editing-disabled');
            scheduleForm.classList.add('editing-enabled');
        } else {
            scheduleForm.classList.add('editing-disabled');
            scheduleForm.classList.remove('editing-enabled');
        }
    }
    // --- END NEW FUNCTION ---

    // --- Initial setup ---
    if (scheduleEditToggle) {
        // Set initial state based on toggle (should be unchecked/false by default)
        toggleScheduleEditing(scheduleEditToggle.checked);

        // Add event listener to the toggle
        scheduleEditToggle.addEventListener('change', function() {
            toggleScheduleEditing(this.checked);
        });
    } else {
        console.error("Schedule edit toggle switch not found!");
    }

}); // End DOMContentLoaded
</script>
{% endblock %} 